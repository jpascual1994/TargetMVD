// Place all the behaviors and hooks related to the matching controller here.
// All this logic will automatically be available in application.js.
// You can use CoffeeScript in this file: http://coffeescript.org/
var map;
// Montevideo latitude and longitude
const default_lat = -34.906349;
const default_lng = -56.19992;
const targetColor = '#efc638';

var pos = {
  lat: default_lat,
  lng: default_lng
};

function initMap() {
  map = new google.maps.Map(document.getElementById('map'), {
    center: pos,
    zoom: 18
  });

  var marker = new google.maps.Marker({
    position: pos,
    map: map,
    icon: '<%= image_path "marker.png" %>'
  });

  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(position) {
      pos = {
        lat: position.coords.latitude,
        lng: position.coords.longitude
      };

      map.setCenter(pos);
      marker.setPosition(pos);
    }, function() {
      // User has disable Geolocation
      alert('Plese enable your location')
    });
  }
}

function displayTargets() {
  var route = $('.get-targets-path').data('path');
  $.get(route).done(function(data) {
    $.each(data.user_targets, function(i, val) {
      var targetPos = {
        lat: val.lat,
        lng: val.lng
      }
      showTarget(targetPos, val.radius, val.icon)
    })
  })
}

function showTarget(position, radius, icon){
  new google.maps.Circle({
    strokeWeight: 0,
    fillColor: targetColor,
    fillOpacity: 0.70,
    map: map,
    center: position,
    radius: radius
  })
  new google.maps.Marker({
    position: position,
    map: map,
    icon: {
      url: icon,
      anchor: new google.maps.Point(6, 6)
    }
  })
};

$(document).ready(function() {
  initMap();
  displayTargets();
});
